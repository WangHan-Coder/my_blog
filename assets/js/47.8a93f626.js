(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{462:function(t,s,a){"use strict";a.r(s);var e=a(1),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("img",{attrs:{src:t.$withBase("/vue/vue2/响应式原理.png"),alt:"图片加载失败"}}),t._v(" "),s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("我们都知道，"),s("code",[t._v("Vue")]),t._v("的特点之一就是"),s("code",[t._v("数据驱动视图")]),t._v("，就是说数据发生变化之后，视图会进行更新，这背后的原理就是vue的响应式系统。应用在运行时需要不断地进行渲染，而响应式系统的任务就是"),s("code",[t._v("让视图随着状态的变化而变化")]),t._v("。接下来探索一下Vue2.0的响应式原理。")]),t._v(" "),s("h2",{attrs:{id:"正文"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#正文"}},[t._v("#")]),t._v(" 正文")]),t._v(" "),s("h3",{attrs:{id:"_1-如何监听对象变化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-如何监听对象变化"}},[t._v("#")]),t._v(" 1.如何监听对象变化？")]),t._v(" "),s("p",[t._v("对于JavaScript对象来说，如何侦测一个对象的变化？")]),t._v(" "),s("p",[t._v("这主要有两种方式，一个是使用"),s("code",[t._v("Object.defineProperty")]),t._v("，另一个是ES6提供的"),s("code",[t._v("Proxy")]),t._v("。而"),s("code",[t._v("Proxy")]),t._v("在浏览器的支持度并不理想，所以vue2.0当时实现的时候采用了"),s("code",[t._v("Object.defineProperty")]),t._v("，重写属性的代码如下:")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("defineReactive")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" val")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("defineProperty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("configurable")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("enumerable")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" val\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newVal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newVal "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" val"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n            val "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" newVal\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("p",[t._v("我们定义一个"),s("code",[t._v("defineReactive")]),t._v("函数，用"),s("code",[t._v("闭包")]),t._v("保留一个"),s("code",[t._v("val")]),t._v("，当页面取值的时候，会走到"),s("code",[t._v("get")]),t._v("函数，返回"),s("code",[t._v("val")]),t._v("，数据改变会触发"),s("code",[t._v("set")]),t._v("函数，修改"),s("code",[t._v("val")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"_2-如何监听数组变化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-如何监听数组变化"}},[t._v("#")]),t._v(" 2.如何监听数组变化？")]),t._v(" "),s("p",[t._v("我们都知道，数组其实也是对象，同样可以用"),s("code",[t._v("Object.defineProperty")]),t._v("劫持数组的每一项，但如果数组有100万项，那就要调用"),s("code",[t._v("Object.defineProperty")]),t._v("一百万次，这样的话性能太低了。鉴于平时我们操作数组大都是采用数组提供的原生方法，于是Vue对数组重写原型链，在调用7个能改变自身的原生方法("),s("code",[t._v("push")]),t._v("，"),s("code",[t._v("pop")]),t._v("，"),s("code",[t._v("shift")]),t._v("，"),s("code",[t._v("unshift")]),t._v("，"),s("code",[t._v("splice")]),t._v("，"),s("code",[t._v("sort")]),t._v("，"),s("code",[t._v("reverse")]),t._v(")时，通知页面进行刷新，具体实现过程如下：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 先拿到数组的原型")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" oldArrayProtoMethods "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Array")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用Object.create创建一个以oldArrayProtoMethods为原型的对象")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" arrayMethods "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldArrayProtoMethods"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" methods "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'push'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pop'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'shift'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'unshift'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sort'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'reverse'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'splice'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nmethods"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("method")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 给arrayMethods定义7个方法")]),t._v("\n    arrayMethods"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("args")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 先找到数组对应的原生方法进行调用")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldArrayProtoMethods"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 声明inserted，用来保存数组新增的数据")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" inserted\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// __ob__是Observer类实例的一个属性，data中的每个对象都是一个Observer类的实例")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ob "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("__ob__\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'push'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'unshift'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n                inserted "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" args\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'splice'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n                inserted "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 比如有新增的数据，新增数据也要被定义为响应式")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inserted"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ob"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("observeArray")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inserted"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通知页面更新")]),t._v("\n        ob"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dep"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("notify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br")])]),s("h3",{attrs:{id:"_3-如何收集依赖以及依赖更新"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-如何收集依赖以及依赖更新"}},[t._v("#")]),t._v(" 3.如何收集依赖以及依赖更新？")]),t._v(" "),s("p",[t._v("在Vue的响应式系统中，有三个核心类，它们分别是")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("Observer")]),t._v("：我们data中的每个对象会返回一个Observer类的实例；")]),t._v(" "),s("li",[s("code",[t._v("Dep")]),t._v("：对象中每个属性会创建一个Dep，另外每一个对象还会单独创建一个Dep；")]),t._v(" "),s("li",[s("code",[t._v("Watcher")]),t._v("：也就是"),s("code",[t._v("依赖")]),t._v("，Watcher有三种")])]),t._v(" "),s("ul",[s("li",[s("code",[t._v("渲染Watcher")]),t._v("：Vue会为每个组件会创建一个渲染Watcher（函数式组件除外）；")]),t._v(" "),s("li",[s("code",[t._v("用户Watcher")]),t._v("：我们自己在watch对象中写的watch；")]),t._v(" "),s("li",[s("code",[t._v("计算属性Watcher")]),t._v("：我们自己定义的计算属性，最终也是靠Watcher来实现的；")])]),t._v(" "),s("p",[t._v("步骤：")]),t._v(" "),s("ol",[s("li",[t._v("创建渲染"),s("code",[t._v("Watcher")]),t._v("，默认会调用this.get方法")]),t._v(" "),s("li",[t._v("将当前渲染"),s("code",[t._v("Watcher")]),t._v("保存在Dep.target上")]),t._v(" "),s("li",[t._v("调用vm._render，会去data上取值，走到"),s("code",[t._v("get")]),t._v("方法，并将当前属性的"),s("code",[t._v("Dep")]),t._v("和Dep.target的渲染Watcher进行关联，")]),t._v(" "),s("li",[t._v("当数据更新时，会走到数据的"),s("code",[t._v("set")]),t._v("方法，"),s("code",[t._v("set")]),t._v("方法中会调用"),s("code",[t._v("Dep.notify")]),t._v("方法，找到当前Dep依赖的Watcher，调用watcher.update方法")]),t._v(" "),s("li",[t._v("重新调用vm._render进行取值。")])]),t._v(" "),s("h3",{attrs:{id:"_4-整体流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-整体流程"}},[t._v("#")]),t._v(" 4.整体流程")]),t._v(" "),s("ol",[s("li",[t._v("遍历data中的数据，如果是"),s("code",[t._v("obj")]),t._v("就创建一个"),s("code",[t._v("Observer")]),t._v("实例，"),s("code",[t._v("new Observer(obj)")])]),t._v(" "),s("li",[t._v("给当前对象增加一个"),s("code",[t._v("Dep实例")]),t._v("，并当前实例保存在"),s("code",[t._v("__ob__")]),t._v("属性上，"),s("code",[t._v("this.__ob__ = this")]),t._v("，表示当前属性已经被代理")]),t._v(" "),s("li",[t._v("判断传入对象是不是数组，如果是数组则重写原型链，拦截"),s("code",[t._v("push")]),t._v(","),s("code",[t._v("pop")]),t._v(","),s("code",[t._v("shift")]),t._v(","),s("code",[t._v("unshift")]),t._v(","),s("code",[t._v("splice")]),t._v(","),s("code",[t._v("sort")]),t._v(","),s("code",[t._v("reverse")]),t._v("七个方法，并调用observeArray遍历数组，将数组的每一项的对象定义为响应式")]),t._v(" "),s("li",[t._v("如果不是数组则是对象，则调用"),s("code",[t._v("walk")]),t._v("方法循环对象，对每个属性调用"),s("code",[t._v("defineReactive")]),t._v("方法，在"),s("code",[t._v("defineReactive")]),t._v("方法中会为当前属性创建一个"),s("code",[t._v("Dep")]),t._v("实例，并调用"),s("code",[t._v("Object.defineProperty")]),t._v("进行重新定义"),s("code",[t._v("get")])]),t._v(" "),s("li",[t._v("创建"),s("code",[t._v("渲染Watcher")]),t._v("进行页面渲染，将当前Watcher放到"),s("code",[t._v("Dep.target")]),t._v("上，"),s("code",[t._v("Dep.target = [Watcher]")])]),t._v(" "),s("li",[t._v("调用"),s("code",[t._v("vm._render")]),t._v("，会取值，走到"),s("code",[t._v("get")]),t._v("方法，将"),s("code",[t._v("Dep")]),t._v("和"),s("code",[t._v("target")]),t._v("关联，再调用"),s("code",[t._v("vm._update")]),t._v("将虚拟节点创建为真实节点并渲染到页面上")]),t._v(" "),s("li",[t._v("数据更新，走到"),s("code",[t._v("set")]),t._v("方法，调用"),s("code",[t._v("Dep.notify")]),t._v("方法，找到当前"),s("code",[t._v("Dep")]),t._v("收集的"),s("code",[t._v("Watcher")]),t._v("，调用"),s("code",[t._v("Watcher.update")])]),t._v(" "),s("li",[t._v("重新调用"),s("code",[t._v("vm._render")]),t._v(",再调用"),s("code",[t._v("vm._update")]),t._v("将虚拟节点创建为真实节点并渲染到页面上")])]),t._v(" "),s("h3",{attrs:{id:"_5-object-defineproperty的缺点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-object-defineproperty的缺点"}},[t._v("#")]),t._v(" 5.Object.defineProperty的缺点")]),t._v(" "),s("ol",[s("li",[t._v("无法监听新增属性和删除属性的变化")]),t._v(" "),s("li",[t._v("监测数组的索引性能太低，故而直接通过数组索引改值无法触发响应式")]),t._v(" "),s("li",[t._v("初始化时需要一次性递归调用，性能较差")])]),t._v(" "),s("h3",{attrs:{id:"_6-proxy和object-defineproperty对比"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-proxy和object-defineproperty对比"}},[t._v("#")]),t._v(" 6.proxy和Object.defineProperty对比")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("Vue3.0")]),t._v("的proxy：代理"),s("code",[t._v("对象")]),t._v("，能监听到对象新增属性和删除属性，以及数组的索引和length变化，可以进行懒递归，性能较好，")]),t._v(" "),s("li",[s("code",[t._v("Vue2.0")]),t._v("的Object.defineProperty: 代理"),s("code",[t._v("属性")]),t._v("，只能能监听到对象已有的属性，监听数组索引性能消耗大，不能进行懒递归，性能较差。")])])])}),[],!1,null,null,null);s.default=n.exports}}]);