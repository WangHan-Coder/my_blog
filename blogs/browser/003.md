---
title: 003 页面渲染流程
date: 2021-07-12
categories: 
 - 浏览器工作原理
tags:
 - 浏览器渲染原理
sidebar: 'auto'
---

我们可以通过编写HTML、CSS和JavaScript文件来让浏览器展示出一个漂亮的页面，但它们是如何转化成页面的呢？

由于渲染机制过于复杂，所以渲染模块在执行过程中会被划分成很多子阶段，输入的HTML经过这些子阶段后，最终输出像素。这样的一个处理流程叫做**渲染流水线**。

按照渲染的时间顺序，流水线可被划分为如下几个子阶段：构建DOM树、样式计算、布局阶段、分层、绘制、分块、光栅化和合成。

## 构建DOM树

**由于浏览器无法直接理解和使用HTML，所以需要将HTML转换成浏览器能够理解的结构-DOM树**。这个跟描述程序语法结构的ast（抽象语法树）类似。可以在控制台中输入“document”后回车，查看DOM结构。

## 样式计算（Recalculate Style）

通过样式计算，计算出DOM节点中每个元素的样式。这个阶段可分为三步：

1. 把CSS转换为浏览器能够理解的结构

CSS样式来源主要有三种：

- 通过link引用的外部CSS文件
- style标签内的CSS
- 行内样式，元素style属性内嵌的CSS

和HTML一样，浏览器也是无法理解这些CSS文本，所以**当渲染引擎接收到CSS文本时，会执行一次转换操作，将CSS文本转换为浏览器可以理解的结构——styleSheets。**可以在控制台输入document.styleSheets查看其结构。

styleSheets包括了三种来源的CSS，并提供了查询和修改的功能。

2. 转换样式表中的属性值，使其标准化

CSS中有些属性值是为了方便开发人员而设计的，但渲染引擎并不容易理解。

```css
p {
  color: blue;
  font-size: 2rem;
  font-weight: bold;
}
```
经过转化后的结果为：

```css
p {
  color: rgb(0, 0, 255);
  font-size: 28px;
  font-weight: 700;
}
```

3. 计算出DOM树种每个节点的具体样式。

**这就设计到CSS的继承规则和层叠规则了。**

CSS继承是指每个DOM节点都包含有父节点的样式。需要注意的是，**浏览器有一组UserAgent的默认样式，如果你不提供样式，默认会使用它。**

## 布局阶段

布局：计算DOM树中可见元素的几何位置的过程叫做布局。Chrome在布局阶段需要完成两个任务：创建布局树和布局计算。

1. 创建布局树

DOM树中会包含一些不可见的元素，比如head标签，还有使用了display:none属性的元素，所以**在显示之前，我们还要额外地构建一颗只包含可见元素的布局树。**

创建布局树过程：

- 遍历DOM树中的所有可见节点，并把这些节点加到布局树中；
- 不可见的节点会被布局树忽略掉，如head标签下面的全部内容和包含display:none属性的元素。

2. 布局计算

有了一棵完整的布局树之后，接下来就要计算布局树节点的坐标位置了。

## 分层

生成布局树，并计算出每个元素的具体位置之后，是不是就要着手绘制页面了？

答案是否定的。

因为页面中有很多复杂的效果，如一些复杂的3D变换、页面滚动、或者使用z-indexing做z轴排序等，为了更加方便地实现这些效果，**渲染引擎还需要为特定的节点生成专用的图层，并生成一棵对应的图层树（LayerTree）。**正是这些图层叠加在一起构成了最终的页面图像。

可以通过Chrome开发者工具，选择“Layers”标签，就可以可视化页面的分层情况。

通常情况下，**并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的图层，那么这个节点就从属于父节点的图层。**但不管怎样，最终每一个节点都会直接或者间接地从属于同一个层。

满足以下任意一条，渲染引擎会为这个节点创建一个单独的图层：

- 拥有层叠上下文属性的元素会被提升到单独的一层，比如明确定位的元素（position），定义透明的元素（opacity），使用CSS滤镜的元素（filter）等，都拥有层叠上下文。

