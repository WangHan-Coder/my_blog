---
title: 003 JS作用域和闭包
date: 2021-06-30
categories:
  - JavaScript
tags:
  - JS基础
sidebar: "auto"
---

能够储存变量的值，并能对这个值进行访问和修改，几乎是所有语言最基本的功能之一，而这也把**状态**带给了程序。那在JavaScript中，变量将会如何存储？而后又如何找到它们呢？

为了解决这个问题，就需要设计一套良好的规则来储存并可以方便地找到这些变量，这套规则被称为**作用域**。

## 编译原理

虽然JavaScript被定义为一门“动态”、“解释执行”的语言，但事实上它是一门编译语言，在传统编译语言的流程中，程序中的一行源代码在执行之前会经历三个步骤：
1. 分词/词法分析（Tokenizing/Lexing）

这个过程会将源代码字符串分解成有意义的代码块，即**词法单元（token）**。举个例子，var a = 1;这行代码通常会被分解为var、a、=、1、;。其中空格是否会被当作词法单元，取决于空格在这门语言中是否具有意义。

2. 解析/语法分析（Parsing）

这个过程是将词法单元流（数组）转换成一个由元素逐级嵌套所组成的描述程序语法结构的树，也就是“**抽象语法树（Abstract Syntax Tree，AST）**”。var a = 1;的抽象语法树中可能会有一个叫做VariableDeclaration的顶级节点，接下来是一个叫做Identifier的name为a的子节点，以及一个值为1的NumericLiteral子节点。
<img :src="$withBase('/js/ast.png')" alt="图片加载失败">

3. 代码生成

将AST转化成可执行代码的过程叫做代码生成，不同的语言和目标平台生成的代码会有差异。而对于JavaScript，简单来说，就是把var a = 1;的AST转化成一组机器指令，用来创建一个a变量，给它分配内存，并将一个值存在a中。

这三个过程统称为**编译**，而与编译过程只有这三个步骤的语言相的编译器相比，JavaScript引擎要复杂得多。比如，在语法分析和代码生成阶段有特定的步骤来对运行性能进行优化，包括对热点代码的发现和监控，对冗余元素进行优化等。运用JIT实现惰性编译甚至实施重编译等。