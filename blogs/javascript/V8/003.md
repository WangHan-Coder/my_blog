---
title: 003 V8的快属性和慢属性
date: 2021-05-03
categories: 
 - JavaScript
tags:
 - JS引擎V8
sidebar: 'auto'
---

javascript中的对象是一组组属性和值的集合，类似于数据结构中的**字典**，字符串作为键名，任意对象可作为键值，通过键名可以读取键值。

不过V8在实现对象存储的时候。并没有采取字典这种存储结构，因为字典是**非线性**的存储结构，查询效率较低。

这里提到了两个概念：
1. 字典

字典（dictionary）是一些元素的集合。每个元素有一个称作key的域，不同元素的key各不相同，其操作有查询、插入和删除。

2. 非线性结构

线性结构的特点是**存储连续**，每个位置之间的偏移量固定，通过线性结构的首位和对应位置的下标就可以算出数据存储的位置，假设首位的位置为s，每个位置的偏移量为8，索引为i，那么这个线性结构任意位置的的计算公式为：
```js
p = s +  i * 8
```
这也是索引值从0开始的原因之一，因为如果从1开始的话公式就变为p = s +  (i - 1)* 8，多了一次减运算。线性结构的代表为数组、队列、栈等。

非线性结构的特点是**零散分布**，比如堆、链表、字典等。

线性结构由于存储连续，虽然查询快，但是能存储的容量有限，因为在内存中很难找到一块很大的连续空间。非线性结构虽然查询慢，但能存储的数据量大。

为了提高效率，v8采用了一套复杂的存储策略。

## 排序属性（elements）和常规属性（properties）
我们把对象中的数组属性称为**排序属性**，字符串属性称为**常规属性**。根据ECMAScript规范，**数字属性应该按照索引值大小升序排列，字符串属性应根据创建时间升序排列。**
```js
function Factory() {
  this[3] = '3'
  this['c'] = 'test-c'
  this[1] = '1'
  this['a'] = 'a'
  this['h'] = 'h'
  this[2] = '2'
  this['b'] = 'b'
}
console.log(new Factory())
// 打印结果（其结果和for in循环一样）
/**
{
  '1': '1',
  '2': '2',
  '3': '3',
  c: 'c',
  a: 'a',
  h: 'h',
  b: 'b'
}
*/
```